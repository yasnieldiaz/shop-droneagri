generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id               String               @id @default(cuid())
  sku              String               @unique
  slug             String               @unique
  type             ProductType          @default(PRODUCT)
  category         String?
  status           ProductStatus        @default(DRAFT)
  pricePLN         Int
  priceEUR         Int
  compareAtPLN     Int?
  compareAtEUR     Int?
  stock            Int                  @default(0)
  trackInventory   Boolean              @default(true)
  lowStockAlert    Int                  @default(5)
  weight           Float?
  featured         Boolean              @default(false)
  sortOrder        Int                  @default(0)
  mainImage        String?
  gallery          String[]             @default([])
  parentProductId  String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  preorderLeadTime Int?
  cartItems        CartItem[]
  inventoryLogs    InventoryLog[]
  orderItems       OrderItem[]
  translations     ProductTranslation[]
  b2bPrices        B2BPrice[]
  parentProduct    Product?             @relation("ProductVariants", fields: [parentProductId], references: [id])
  variants         Product[]            @relation("ProductVariants")

  @@map("products")
}

model ProductTranslation {
  id              String   @id @default(cuid())
  productId       String
  locale          String
  name            String
  tagline         String?
  description     String?
  features        Json?
  specs           Json?
  metaTitle       String?
  metaDescription String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale])
  @@map("product_translations")
}

model B2BCustomer {
  id              String     @id @default(cuid())
  email           String     @unique
  password        String
  companyName     String
  vatNumber       String?    @unique
  country         String
  region          B2BRegion  @default(EU)
  contactName     String
  contactPhone    String?
  street          String
  city            String
  postalCode      String
  status          B2BStatus  @default(pending)
  viesValidated   Boolean    @default(false)
  viesValidatedAt DateTime?
  approvedAt      DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @default(now()) @updatedAt
  lastLoginAt     DateTime?
  b2b_prices      B2BPrice[]
  orders          B2BOrder[]

  @@map("b2b_customers")
}


model B2BOrder {
  id          String         @id @default(cuid())
  orderNumber String         @unique
  customerId  String
  status      String         @default("pending")
  totalPLN    Int?
  totalEUR    Int?
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @default(now()) @updatedAt
  customer    B2BCustomer    @relation(fields: [customerId], references: [id])
  items       B2BOrderItem[]

  @@map("b2b_orders")
}

model B2BOrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String
  productName String
  productSku  String
  quantity    Int
  unitPrice   Int
  totalPrice  Int
  order       B2BOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("b2b_order_items")
}

model B2BPrice {
  product       Product      @relation(fields: [productId], references: [id])
  id            String       @id @default(cuid())
  productId     String
  region        B2BRegion
  pricePL       Int?
  priceEU       Int?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @default(now()) @updatedAt
  productSku    String?
  b2bCustomerId String?
  discountPL    Float?       @db.Real
  discountEU    Float?       @db.Real
  b2b_customers B2BCustomer? @relation(fields: [b2bCustomerId], references: [id], onDelete: Cascade)

  @@unique([productId, region])
  @@map("b2b_prices")
}

model Order {
  id              String         @id @default(cuid())
  orderNumber     String         @unique
  userId          String?
  customerEmail   String
  customerName    String
  customerPhone   String?
  shippingAddress Json
  billingAddress  Json?
  subtotal        Int
  shippingCost    Int            @default(0)
  tax             Int            @default(0)
  total           Int
  currency        String         @default("PLN")
  status          OrderStatus    @default(PENDING)
  paymentStatus   PaymentStatus  @default(PENDING)
  paymentMethod   PaymentMethod?
  customerNotes   String?
  adminNotes      String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  items           OrderItem[]
  user            User?          @relation(fields: [userId], references: [id])
  payments        Payment[]

  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String
  productName String
  productSku  String
  quantity    Int
  unitPrice   Int
  totalPrice  Int
  currency    String
  createdAt   DateTime @default(now())
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  phone         String?
  role          UserRole  @default(CUSTOMER)
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  addresses     Address[]
  carts         Cart?
  orders        Order[]

  @@map("users")
}

model Address {
  id           String      @id @default(cuid())
  userId       String
  type         AddressType @default(SHIPPING)
  firstName    String
  lastName     String
  company      String?
  street       String
  streetNumber String
  apartment    String?
  city         String
  postalCode   String
  country      String      @default("PL")
  phone        String?
  isDefault    Boolean     @default(false)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

model Cart {
  id        String     @id @default(cuid())
  userId    String?    @unique
  sessionId String?    @unique
  currency  String     @default("PLN")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  items     CartItem[]
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  quantity  Int      @default(1)
  unitPrice Int
  currency  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
  @@map("cart_items")
}

model Payment {
  id              String        @id @default(cuid())
  orderId         String
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  amount          Int
  currency        String
  stripePaymentId String?
  paypalOrderId   String?
  bankReference   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model InventoryLog {
  id        String           @id @default(cuid())
  productId String
  type      InventoryLogType
  quantity  Int
  reason    String?
  orderId   String?
  createdBy String?
  createdAt DateTime         @default(now())
  product   Product          @relation(fields: [productId], references: [id])

  @@map("inventory_logs")
}

model NewsletterSubscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  locale    String   @default("pl")
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@map("newsletter_subscribers")
}

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Customer {
  id        String   @id @default(cuid())
  email     String   @unique
  firstName String
  lastName  String
  phone     String?
  company   String?
  nip       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@map("customers")
}

model SerialRecord {
  id           String   @id @default(cuid())
  productCode  String
  serialNumber String   @unique
  notes        String?
  createdAt    DateTime @default(now())

  @@map("serial_records")
}

enum ProductType {
  PRODUCT
  SPARE_PART
  ACCESSORY
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum B2BRegion {
  POLAND
  EU
}

enum B2BStatus {
  pending
  approved
  rejected
}

enum AddressType {
  SHIPPING
  BILLING
}

enum InventoryLogType {
  ADJUSTMENT
  SALE
  RESTOCK
  RETURN
}

enum OrderStatus {
  PENDING
  AWAITING_PAYMENT
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  STRIPE
  PAYPAL
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum UserRole {
  CUSTOMER
  ADMIN
}
