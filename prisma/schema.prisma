generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============== USERS ==============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  phone         String?
  role          UserRole  @default(CUSTOMER)
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  addresses Address[]
  orders    Order[]
  cart      Cart?

  @@map("users")
}

enum UserRole {
  CUSTOMER
  ADMIN
}

model Address {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         AddressType @default(SHIPPING)
  firstName    String
  lastName     String
  company      String?
  street       String
  streetNumber String
  apartment    String?
  city         String
  postalCode   String
  country      String   @default("PL")
  phone        String?
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("addresses")
}

enum AddressType {
  SHIPPING
  BILLING
}

// ============== PRODUCTS ==============

model Product {
  id              String        @id @default(cuid())
  sku             String        @unique
  slug            String        @unique
  type            ProductType   @default(PRODUCT)
  category        String?
  status          ProductStatus @default(DRAFT)
  pricePLN        Int           // Price in groszy (cents)
  priceEUR        Int           // Price in euro cents
  compareAtPLN    Int?          // Original price for discounts
  compareAtEUR    Int?
  stock           Int           @default(0)
  trackInventory  Boolean       @default(true)
  lowStockAlert   Int           @default(5)
  weight          Float?        // kg
  featured        Boolean       @default(false)
  sortOrder       Int           @default(0)
  mainImage       String?
  gallery         String[]      @default([])

  // Parent product for spare parts
  parentProductId String?
  parentProduct   Product?      @relation("ProductParts", fields: [parentProductId], references: [id])
  spareParts      Product[]     @relation("ProductParts")

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  translations ProductTranslation[]
  cartItems    CartItem[]
  orderItems   OrderItem[]
  inventory    InventoryLog[]

  @@map("products")
}

enum ProductType {
  PRODUCT
  SPARE_PART
  ACCESSORY
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

model ProductTranslation {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  locale      String   // en, pl
  name        String
  tagline     String?
  description String?  @db.Text
  features    Json?    // Array of feature objects
  specs       Json?    // Key-value specifications
  metaTitle   String?
  metaDescription String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([productId, locale])
  @@map("product_translations")
}

// ============== CART ==============

model Cart {
  id        String     @id @default(cuid())
  userId    String?    @unique
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String?    @unique
  currency  String     @default("PLN")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int      @default(1)
  unitPrice Int      // Price at time of adding
  currency  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
  @@map("cart_items")
}

// ============== ORDERS ==============

model Order {
  id                  String        @id @default(cuid())
  orderNumber         String        @unique
  userId              String?
  user                User?         @relation(fields: [userId], references: [id])

  // Customer info (for guest checkout)
  customerEmail       String
  customerName        String
  customerPhone       String?

  // Addresses stored as JSON for history
  shippingAddress     Json
  billingAddress      Json?

  // Totals
  subtotal            Int
  shippingCost        Int           @default(0)
  tax                 Int           @default(0)
  total               Int
  currency            String        @default("PLN")

  // Status
  status              OrderStatus   @default(PENDING)
  paymentStatus       PaymentStatus @default(PENDING)
  paymentMethod       PaymentMethod?

  // Notes
  customerNotes       String?
  adminNotes          String?

  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  items    OrderItem[]
  payments Payment[]

  @@map("orders")
}

enum OrderStatus {
  PENDING
  AWAITING_PAYMENT
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  STRIPE
  PAYPAL
  BANK_TRANSFER
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  productName String   // Stored for history
  productSku  String
  quantity    Int
  unitPrice   Int
  totalPrice  Int
  currency    String
  createdAt   DateTime @default(now())

  @@map("order_items")
}

model Payment {
  id              String        @id @default(cuid())
  orderId         String
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  amount          Int
  currency        String

  // Provider details
  stripePaymentId String?
  paypalOrderId   String?
  bankReference   String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("payments")
}

// ============== INVENTORY ==============

model InventoryLog {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  type        InventoryLogType
  quantity    Int      // Positive for additions, negative for deductions
  reason      String?
  orderId     String?
  createdBy   String?
  createdAt   DateTime @default(now())

  @@map("inventory_logs")
}

enum InventoryLogType {
  ADJUSTMENT
  SALE
  RESTOCK
  RETURN
}

// ============== NEWSLETTER ==============

model NewsletterSubscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  locale    String   @default("pl")
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("newsletter_subscribers")
}
